import streamlit as st
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import matplotlib
from st_aggrid import AgGrid, GridOptionsBuilder

# ä¸­æ–‡å­—é«”è¨­å®š
matplotlib.rcParams['font.family'] = 'Microsoft JhengHei'
matplotlib.rcParams['axes.unicode_minus'] = False

# é é¢æ¨™é¡Œ
st.title("é¡§å®¢è³¼è²·è¡Œç‚ºåˆ†æå„€è¡¨æ¿")

# è³‡æ–™è®€å–
rfm = pd.read_csv("rfm.csv")
df = pd.read_csv("transactions.csv")

# åˆ†ç¾¤åç¨±å°æ‡‰
cluster_name_map = {
    0: 'é«˜åƒ¹å€¼é¡§å®¢',
    1: 'æ²‰ç¡é¡§å®¢',
    2: 'æ½›åŠ›å‹é¡§å®¢',
    3: 'å¶çˆ¾å‹é¡§å®¢'
}
rfm['ClusterLabel'] = rfm['Cluster'].map(cluster_name_map)

# åˆ†ç¾¤ç¸½è¦½
st.header("ğŸ“Š å„ç¾¤çµ„å¹³å‡ RFM å€¼")
cluster_summary = rfm.groupby('ClusterLabel')[['Recency', 'Frequency', 'Monetary']].mean().round(2)
st.dataframe(cluster_summary)

# é¡§å®¢åˆ†ç¾¤è¦–è¦ºåŒ–ï¼ˆPCAï¼‰
st.header("ğŸ¯ é¡§å®¢åˆ†ç¾¤æ•£é»åœ– (PCA)")
fig, ax = plt.subplots()
sns.scatterplot(data=rfm, x='PCA1', y='PCA2', hue='ClusterLabel', palette='Set2', alpha=0.6, ax=ax)
st.pyplot(fig)

# æ¯ç¾¤ç¬¬ä¸€åç†±é–€å•†å“é¡åˆ¥å’Œè³¼è²·æ•¸é‡
st.header("ğŸ›’ å„ç¾¤æœ€ç†±é–€å•†å“åˆ†é¡åŠè³¼è²·æ•¸é‡")
top1_categories = (
    df.merge(rfm[['CustomerID', 'Cluster', 'ClusterLabel']], on='CustomerID')
    .groupby(['ClusterLabel', 'ProductCategory'])
    .size()
    .reset_index(name='Count')
    .sort_values(['ClusterLabel', 'Count'], ascending=[True, False])
    .groupby('ClusterLabel')
    .first()
    .reset_index()
    .rename(columns={
        'ProductCategory': 'ç¬¬ä¸€åå•†å“',
        'Count': 'ç¬¬ä¸€åæ•¸é‡'
    })
)
st.dataframe(top1_categories)

# æ¯ä½é¡§å®¢è³¼è²·æœ€å¤šçš„å•†å“é¡åˆ¥
top_category_per_customer = (
    df.groupby(['CustomerID', 'ProductCategory'])
    .size()
    .reset_index(name='Count')
    .sort_values(['CustomerID', 'Count'], ascending=[True, False])
    .groupby('CustomerID')
    .first()
    .reset_index()
    .rename(columns={'ProductCategory': 'TopCategory'})
)

# åˆä½µåˆ° rfm
rfm_with_topcat = rfm.merge(top_category_per_customer[['CustomerID', 'TopCategory']], on='CustomerID', how='left')

# é¡¯ç¤ºç¾¤çµ„é¡§å®¢æ˜ç´° + é»é¸å¾Œæ¨è–¦
st.header("ğŸ” ç¾¤çµ„é¡§å®¢æ˜ç´°èˆ‡æ¨è–¦")
selected_label = st.selectbox("è«‹é¸æ“‡é¡§å®¢ç¾¤çµ„ï¼š", rfm['ClusterLabel'].unique())

filtered_customers = rfm_with_topcat[rfm_with_topcat['ClusterLabel'] == selected_label]
cols_to_show = ['CustomerID', 'Recency', 'Frequency', 'Monetary', 'TopCategory']

# ä½¿ç”¨ AgGrid é¡¯ç¤ºå¯é¸æ“‡è³‡æ–™è¡¨
gb = GridOptionsBuilder.from_dataframe(filtered_customers[cols_to_show])
gb.configure_selection('single', use_checkbox=True)
grid_options = gb.build()

grid_response = AgGrid(filtered_customers[cols_to_show], gridOptions=grid_options, height=300)

# å€‹äººåŒ–æ¨è–¦é¡¯ç¤ºå€å¡Š
selected_rows = grid_response.get('selected_rows')

if selected_rows is not None and not selected_rows.empty:
    selected_row = selected_rows.iloc[0]  # å–å¾—ç¬¬ä¸€ç­†é¸æ“‡çš„åˆ—
    customer_id = selected_row['CustomerID']
    top_cat = selected_row['TopCategory']

    # è©²é¡§å®¢æ‰€åœ¨ç¾¤çµ„
    customer_cluster_label = rfm_with_topcat.loc[rfm_with_topcat['CustomerID'] == customer_id, 'ClusterLabel'].values[0]

    # è©²ç¾¤çµ„ç†±é–€å•†å“é¡åˆ¥æ’è¡Œï¼ˆä¸åŒ…å«é¡§å®¢ TopCategoryï¼‰
    cluster_top_categories = (
        df.merge(rfm[['CustomerID', 'ClusterLabel']], on='CustomerID')
        .query("ClusterLabel == @customer_cluster_label")
        .groupby('ProductCategory')
        .size()
        .reset_index(name='Count')
        .sort_values('Count', ascending=False)
    )
    cluster_top_categories = cluster_top_categories[cluster_top_categories['ProductCategory'] != top_cat]

    # å–å‰ä¸‰å
    recommended_categories = cluster_top_categories.head(1)['ProductCategory'].tolist()

    # è‹¥ä¸å¤ ä¸‰å€‹ï¼Œè£œå…¨å…¨é«”ç†±é–€é¡åˆ¥ï¼ˆæ’é™¤TopCategoryå’Œå·²æ¨è–¦çš„ï¼‰
    if len(recommended_categories) < 1:
        all_top_categories = (
            df.groupby('ProductCategory')
            .size()
            .reset_index(name='Count')
            .sort_values('Count', ascending=False)
        )
        exclude_list = [top_cat] + recommended_categories
        more_cats = all_top_categories[~all_top_categories['ProductCategory'].isin(exclude_list)].head(1 - len(recommended_categories))['ProductCategory'].tolist()
        recommended_categories += more_cats

    # é¡¯ç¤ºæ¨è–¦çµæœ

    st.subheader("ğŸ å€‹äººåŒ–æ¨è–¦")
    st.markdown(f"**é‡å°é¡§å®¢ `{customer_id}` çš„è³¼è²·åå¥½ï¼Œæ¨è–¦æ›´å¤š `{top_cat}`ã€`{', '.join(recommended_categories)}` é¡åˆ¥çš„å•†å“**")
